import{r as c,j as e}from"./index-DP3cqZMk.js";import{a as u,b as g}from"./viewport-CIRotvhe.js";import{D as T,f as z,E as q,F as X}from"./owner-eagQWD7v.js";import{g as D,u as Z,C as Q,a as J,b as Y,c as ee,M as se,d as M,e as v,f as w,U as N,s as b,h,i as te,E as ae,j as ne,S as re}from"./utils-CfXHZo-d.js";import{A as B}from"./Shiki-BY37ZjXb.js";import{c as k,a as d,M as oe,S as ie}from"./StyledButton-Dw1NSLdk.js";import{c as ce,d as C,u as le,e as E}from"./index-ruaAFTxf.js";import{r as P,F as me,a as de}from"./FormInput-Cm8TmlFT.js";import{a as ue}from"./alert-CD03bL8S.js";import{A as xe}from"./index-D6p5TRFo.js";import{m as y}from"./proxy-Nduva4Ti.js";import{I as he}from"./Gallery-C9cHB7g0.js";import{u as ge}from"./useQuery-C2j6PTNF.js";import{G as pe}from"./SocialSourceLink-Dld2WA2_.js";import"./provider-CEmImVai.js";import"./use-ref-value-Bw8XjGYB.js";import"./index-D7tm2AmB.js";import"./FloatPopover-SF_LLQpc.js";import"./spring-C80N1tKa.js";import"./use-event-callback-CNvn5lcI.js";import"./dom-BowoBODo.js";import"./image-qDpgj1f_.js";import"./use-is-dark-BUJCkWoz.js";import"./customParseFormat-B6mKyGeh.js";import"./use-drag-controls-BQqh8BIu.js";import"./visual-element-CEM7Lww2.js";import"./LinkCard-DRRSL1xL.js";import"./use-motion-template-CG2NZtUh.js";import"./index-BqTMT-9N.js";import"./Collapse-vVB60taR.js";import"./use-is-unmounted-s8iE4ntz.js";var A="Avatar",[fe,bs]=ce(A),[je,$]=fe(A),F=c.forwardRef((s,t)=>{const{__scopeAvatar:n,...a}=s,[r,o]=c.useState("idle");return e.jsx(je,{scope:n,imageLoadingStatus:r,onImageLoadingStatusChange:o,children:e.jsx(C.span,{...a,ref:t})})});F.displayName=A;var U="AvatarImage",_=c.forwardRef((s,t)=>{const{__scopeAvatar:n,src:a,onLoadingStatusChange:r=()=>{},...o}=s,l=$(U,n),i=be(a),m=le(x=>{r(x),l.onImageLoadingStatusChange(x)});return E(()=>{i!=="idle"&&m(i)},[i,m]),i==="loaded"?e.jsx(C.img,{...o,ref:t,src:a}):null});_.displayName=U;var O="AvatarFallback",V=c.forwardRef((s,t)=>{const{__scopeAvatar:n,delayMs:a,...r}=s,o=$(O,n),[l,i]=c.useState(a===void 0);return c.useEffect(()=>{if(a!==void 0){const m=window.setTimeout(()=>i(!0),a);return()=>window.clearTimeout(m)}},[a]),l&&o.imageLoadingStatus!=="loaded"?e.jsx(C.span,{...r,ref:t}):null});V.displayName=O;function be(s){const[t,n]=c.useState("idle");return E(()=>{if(!s){n("error");return}let a=!0;const r=new window.Image,o=l=>()=>{a&&n(l)};return n("loading"),r.onload=o("loaded"),r.onerror=o("error"),r.src=s,()=>{a=!1}},[s]),t}var ye=F,ve=_,we=V;const G=({className:s})=>{const n=u()?.provider,a=n&&D(n);return a?e.jsx("span",{className:k("pointer-events-none flex size-4 select-none items-center justify-center rounded-full bg-white dark:bg-zinc-900",s),children:e.jsx(a,{className:"size-3"})}):null};async function Ne(){return(await ke("csrf"))?.csrfToken}async function ke(s){const n=`${`${T}/auth`}/${s}`;try{const a={headers:{"Content-Type":"application/json"}};a.credentials="include";const r=await fetch(n,a),o=await r.json();if(!r.ok)throw o;return Object.keys(o).length>0?o:null}catch(a){return console.error("CLIENT_FETCH_ERROR",{error:a,url:n}),null}}async function Ce(s,t,n){const{callbackUrl:a=window.location.href,redirect:r=!0}={},o=await P.getProviders(),l=`${T}/auth`;if(!o){window.location.href=`${l}/error`;return}if(!s||!(s in o)){window.location.href=`${l}/signin?${new URLSearchParams({callbackUrl:a})}`;return}const i=o[s].type==="credentials",m=o[s].type==="email",x=i||m,W=`${`${l}/${i?"callback":"signin"}/${s}`}`,p=await fetch(W,{method:"post",headers:{"Content-Type":"application/x-www-form-urlencoded","X-Auth-Return-Redirect":"1"},credentials:"include",body:new URLSearchParams({...t,csrfToken:await Ne(),callbackUrl:a,json:!0})}),f=await p.json();if(r||!x){const R=f.url??a;window.location.href=R,R.includes("#")&&window.location.reload();return}const L=new URL(f.url).searchParams.get("error");return{error:L,status:p.status,ok:p.ok,url:L?null:f.url}}const Ae=s=>{if(s.handle)switch(s.provider){case"github":return`https://github.com/${s.handle}`}};function Se({className:s}){return e.jsx("i",{className:d("icon-[mingcute--send-plane-line]",s)})}const Le=()=>{const s=Y(),t=ee();return e.jsxs("span",{className:d("font-mono text-[10px]",s?"text-red-500":"text-zinc-500"),children:[t.length,"/",se]})},Re=()=>{const s=g(),t=M(),n=z(v().isWhisper),a=w();return s||t?null:e.jsxs("label",{className:"label mx-2 flex items-center",children:[e.jsx("input",{className:"checkbox-accent checkbox checkbox-sm mr-2",checked:n,type:"checkbox",onChange:r=>{const{checked:o}=r.target;a("isWhisper",o)}}),e.jsx("span",{className:"label-text text-sm",children:"悄悄話"})]})},Ie=()=>{const s=g(),t=z(v().syncToRecently),n=w(),a=M();return!s||a?null:e.jsxs("label",{className:"label mx-2 flex items-center",children:[e.jsx("input",{className:"checkbox-accent checkbox checkbox-sm mr-2",checked:t,type:"checkbox",onChange:r=>{const{checked:o}=r.target;n("syncToRecently",o)}}),e.jsx("span",{className:"label-text text-sm",children:"同步到碎碎念"})]})},S=({className:s})=>{const t=Z();return e.jsxs("footer",{className:k("mt-3 flex h-5 w-full min-w-0 items-center justify-between",s),children:[e.jsxs("span",{className:d("flex-1 select-none text-[10px] text-zinc-500 transition-opacity"),children:[e.jsxs("span",{className:"hidden md:inline",children:["支持 ",e.jsx("b",{children:"Markdown"})," 與"," ",e.jsx(ue,{href:"https://docs.github.com/en/get-started/writing-on-github/getting-started-with-writing-and-formatting-on-github/basic-writing-and-formatting-syntax",children:"GFM"})]}),e.jsx(Q,{})]}),e.jsx(xe,{children:t&&e.jsxs(y.aside,{initial:{opacity:0,scale:.96,y:8},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.98,y:8},className:"flex select-none items-center gap-2.5",children:[e.jsx(Le,{}),e.jsx(Re,{}),e.jsx(Ie,{}),e.jsx(Te,{})]},"send-button-wrapper")})]})},Te=()=>{const[s,t]=J();return e.jsxs(y.button,{className:"flex appearance-none items-center space-x-1 disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50",whileHover:{scale:1.05},whileTap:{scale:.95},type:"button",disabled:t,onClick:s,children:[e.jsx(Se,{className:"size-5 text-zinc-800 dark:text-zinc-200"}),e.jsx(y.span,{className:"text-sm",layout:"size",children:t?"送出...":"送出"})]})},ze=()=>{const s=w(),t=u(),n=t?t.name||"Anonymous":"";return c.useEffect(()=>{t&&(s("author",n),s("avatar",t.image),s("mail",t.email),t.handle&&s("url",Ae({provider:t.provider,handle:t.handle})||""),s("source",t.provider))},[n,t,s]),t?e.jsxs("div",{className:"flex space-x-4",children:[e.jsxs("div",{className:d("relative mb-2 shrink-0 select-none self-end rounded-full","bg-zinc-200 ring-2 ring-zinc-200 dark:bg-zinc-800","backface-hidden ml-[2px]"),children:[e.jsxs(ye,{children:[e.jsx(ve,{className:"rounded-full object-cover",src:t.image,alt:`${n}'s avatar`,width:48,height:48}),e.jsx(we,{delayMs:600,className:"block size-[48px] shrink-0 rounded-full"})]}),e.jsx(G,{className:"absolute -bottom-1 right-0"})]}),e.jsx("div",{className:"relative h-[150px] w-full rounded-xl bg-gray-200/50 dark:bg-zinc-800/50",children:e.jsx(N,{className:"pb-5"})}),e.jsx(S,{className:"absolute bottom-0 left-14 right-0 mb-2 ml-4 w-auto px-4"})]}):null},Me=()=>g()?e.jsx($e,{}):e.jsx(Pe,{}),H="relative h-[150px] w-full rounded-xl bg-gray-200/50 dark:bg-zinc-800/50",Be={author:"昵称",mail:"邮箱",url:"网址"},Ee={author:{validator:s=>s.length>0&&s.length<=20,message:"昵称长度应在 1-20 之间"},mail:{validator:s=>/^[\w-]+@[\w-]+(\.[\w-]+)+$/.test(s),message:"邮箱格式不正确"},url:{validator:s=>/^https?:\/\/[a-zA-Z0-9-]+(\.[a-zA-Z0-9-]+)+$/.test(s),message:"网址格式不正确"}},j=s=>{const{fieldKey:t,required:n}=s,[a,r]=X(v()[t]);return e.jsx(de,{type:"text",value:a,onChange:o=>r(o.target.value),required:n,placeholder:Be[t]+(n?" *":""),name:t,className:"bg-gray-200/50 dark:bg-zinc-800/50",rules:[Ee[t]]})},Pe=()=>e.jsxs(me,{className:"flex flex-col space-y-4 px-2 pt-2",showErrorMessage:!1,children:[e.jsxs("div",{className:"flex flex-col space-x-0 space-y-4 md:flex-row md:space-x-4 md:space-y-0",children:[e.jsx(j,{fieldKey:"author",required:!0}),e.jsx(j,{fieldKey:"mail",required:!0}),e.jsx(j,{fieldKey:"url"})]}),e.jsx("div",{className:H,children:e.jsx(N,{className:"pb-8"})}),e.jsx(S,{className:"absolute bottom-4 left-0 right-4 mb-2 ml-2 w-auto px-4"})]}),$e=()=>{const s=q(t=>t.user);return e.jsxs("div",{className:"flex space-x-4",children:[e.jsxs("div",{className:d("relative mb-2 shrink-0 select-none self-end rounded-full","ring-2 ring-accent","backface-hidden ml-[2px]"),children:[e.jsx(he,{className:"rounded-full object-cover",src:s.avatar,alt:`${s.name||s.username}'s avatar`,width:48,height:48}),e.jsx(G,{className:"absolute -bottom-1 right-0"})]}),e.jsx("div",{className:H,children:e.jsx(N,{className:"pb-5"})}),e.jsx(S,{className:"absolute bottom-0 left-14 right-0 mb-2 ml-4 w-auto px-4"})]})},K=()=>{const{data:s}=ge({queryKey:["providers"],queryFn:P.getProviders,refetchOnMount:"always",meta:{persist:!0}});return s},Fe=()=>{const s=K(),[t,n]=c.useState(()=>new Set);return e.jsx(e.Fragment,{children:s&&e.jsx("ul",{className:"flex items-center justify-center gap-3",children:Object.keys(s).map(a=>e.jsx("li",{children:e.jsx(oe,{disabled:t.has(a),onClick:()=>{t.has(a)||(Ce(a),n(r=>(r.add(a),new Set(r))))},children:e.jsx("div",{className:"flex size-10 items-center justify-center rounded-full border bg-base-100 dark:border-neutral-700",children:t.has(a)?e.jsx("div",{className:"center flex",children:e.jsx("i",{className:"loading loading-spinner loading-xs opacity-50"})}):e.jsx(c.Fragment,{children:a==="github"?e.jsx(pe,{}):e.jsx("img",{className:"size-4",src:`https://authjs.dev/img/providers/${a}.svg`})})})})},a))})})};function Ue(){const s=!!u(),t=K(),n=t&&Object.keys(t).length>0;return c.useEffect(()=>{t&&Object.keys(t).length===0&&b(h.legacy)},[t]),s?null:e.jsxs("div",{className:"center flex h-[150px] w-full flex-col rounded-lg bg-gray-100/80 dark:bg-zinc-900/80",children:[e.jsx("p",{className:"mb-4 text-sm",children:"使用社交帳號登入"}),e.jsx(Fe,{}),e.jsx(ie,{className:d(n?"mt-6":""),variant:"secondary",type:"button",onClick:()=>{b(h.legacy)},children:"登入後即可留言"})]})}const ys=s=>{const{refId:t,className:n,afterSubmit:a,initialValue:r}=s,o=te(),l=g(),i=u();return c.useEffect(()=>{i&&b(h["with-auth"])},[i]),e.jsx(ae,{children:e.jsx(ne,{refId:t,afterSubmit:a,initialValue:r,children:e.jsxs("div",{className:k("group relative w-full min-w-0",n),"data-hide-print":!0,children:[e.jsx(re,{}),e.jsx("div",{className:"relative w-full",children:l?e.jsx(I,{}):o===h.legacy?e.jsx(I,{}):e.jsx(_e,{})})]})})})},I=()=>e.jsx(B,{children:e.jsx(Me,{})}),_e=()=>{const s=!!u();return e.jsx(B,{children:s?e.jsx(ze,{}):e.jsx(Ue,{})})};export{ys as CommentBoxRoot};
